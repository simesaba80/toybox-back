# ToybBox Backend Design Doc

## 著者

- simesaba80

## 開発者

- simesaba80
- Taku2515

## 目次

1. [目標](#目標としないもの)
2. [目標としないもの](#目標としないもの)
3. [背景](#背景)
4. [システム概要](#システム概要)
5. [アーキテクチャ設計](#アーキテクチャ設計)
6. [データベース](#データベース)
7. [セキュリティ](#セキュリティ)
8. [運用方針](#運用方針)
9. [テスト方針](#テスト方針)
10. [更新履歴](#更新履歴)

# 目標

C3 部員向けの作品投稿プラットフォーム、ToyBox のバックエンドを作成しなおす。  
データベースに保存されたデータのみ引き継ぎ、それ以外は 1 からの開発となる。
リクエストやレスポンスの形式は変更して構わない。

# 目標としないもの

- ブログの投稿プラットフォームとしての機能
  - ブログの投稿プラットフォームは別のシステムとして提供する予定である。そのためこのバックエンドは作品の取り扱いのみに集中する。

# 背景

このバックエンドのプロジェクトは前身となるバックエンドが既に作成されています。以下がリポジトリの URL です。
https://github.com/Kyutech-C3/toybox-server
前バックエンドは FastAPI で書かれていて、作品投稿プラットフォームおよびブログ投稿プラットフォームとしての機能を提供していました。  
しかし現 C3 部員に FastAPI が得意な人がほぼ残っていないこと、当時の初期設計よりもコードが肥大化したことや、まだバグが多く残っている中での主要な開発メンバーの卒業のために主に保守性の面で大きな困難を抱えています。  
そのため現 C3 部員で扱える人が多い Go を使い、保守性を重視したクリーンアーキテクチャを採用しつつ再開発を進めています

## 参考 URL

[前 ToyBox バックエンド](https://github.com/Kyutech-C3/toybox-server)  
[前 ToyBox フロントエンド](https://github.com/Kyutech-C3/ToyBox-frontend)  
[現 ToyBox バックエンド](https://github.com/simesaba80/toybox-back)  
[現 ToyBox フロントエンド](https://github.com/simesaba80/toybox-front)  

# システム概要

このシステムは以下のようなアーキテクチャで提供されます。  

![toyboxtech.dwawio.png](toyboxtech.drawio.png)  

バックエンドでは開発言語として Go、Web フレームワークとして Echo、ORM として Bun を採用しています。
また開発を補助する CLI ツールとして以下のものを採用しています。
DI を担当する wire、マイグレーションを行う golang-migrate、Swagger 生成用の swag
これらの技術の選定基準は以下の通りです。

- 後方互換性が担保されているか、破壊的変更の頻度が少ないか
- 技術の習得難度が高すぎないか
- 調べる上で情報を見つけやすいか
- 言語以外の技術は簡単に扱うためのラッパーとして機能してくれるか

採用されていない類似技術については[代替案の検討](#代替案の検討)を参照。
アプリケーション、データベース共にDockerコンテナ内で動くことを想定されています。

# アーキテクチャ設計

このプロジェクトでは前 ToyBox バックエンドの反省から長期開発する上で保守性を確保するため、クリーンアーキテクチャを採用しています。  
4 層からなるクリーンアーキテクチャとなっており、以下の 4 層に分かれています。

- ドメイン層
- ユースケース層
- インターフェース層
- インフラストラクチャー層

## ドメイン層

このバックエンドが扱うドメインについて記述します。DB に保存されている情報と等価ではないことに注意してください。他のどの層にも依存しません。他の層のコードがなくても単体で成り立つことができます。また外部ライブラリにも依存しません。現在は一部UUIDのライブラリに依存しているので剥がす必要があります。

### エンティティ

ドメインのモデルについてのみ記述しています。構造体以外は存在しません。値のバリデーションはインターフェース層で行います。現在一部モデルにはValidateメソッドが実装されていますが使われていません。消去する必要があります。

### リポジトリ

ドメインの各モデルが持つメソッドのインターフェースを定義します。メソッドの実装はインフラストラクチャー層のリポジトリで行います。インターフェースによって、ドメイン層が実装に依存しないように依存関係の逆転を行っています。

## ユースケース層

ユースケース層はドメイン層にのみ依存し、ビジネスロジックを記述します。  
例外処理や計算、インターフェースのバリデーターでは処理しきれない値の妥当性や整合性の確認、ドメイン層のリポジトリで定義されたインターフェースを介したSQLの呼び出しなどを行います。  
現状一つのファイルに一つのドメインが対応する形でファイル分割をしています。多くなりすぎる場合分割する必要があります。

## インターフェース層

インフラストラクチャー層とユースケース層の橋渡しをする層です。ユースケース層とドメイン層に依存します。  
主にhttpリクエストの変換等を行います。

### controller

httpリクエストを受け取り、必要に応じてバリデート、ユースケース層に引き渡します。ユースケース層からの返り値に応じてhttpレスポンスを返します。現状一つのファイルに一つのドメインが対応する形でファイル分割をしています。多くなりすぎる場合分割する必要があります。

### schema

httpリクエストのボディの形式やレスポンスの形式の定義、ドメインモデルからレスポンスへの変換等を行います。こちらも現状一つのファイルに一つのドメインが対応する形でファイル分割をしています。多くなりすぎる場合分割する必要があります。

## インフラストラクチャー層

アプリケーションと外部との間のやりとりを担当します。クリーンアーキテクチャにおける最も外側の層にあたり、上記3つ全ての層に依存します。現在は環境変数、データベース、Webフレームワークを取り扱っています。

### config

環境変数の読み込みを行います。

### database

データベース関連のコードがあります。後述するdto、types以外のディレクトリではrepository.goを配置し、ドメイン層で定義したインターフェースの実装を行っています。このインターフェースの実装の中でSQLを実行したりします。  
現在はここでトランザクションの管理も行っています。トランザクション自体はDBの概念だけでなくのより上位の概念としても存在するのでユースケース層に移動する必要があります。

#### dto

data transfer objectの略です。テーブル定義とGoの構造体で1対1対応するものが格納されています。  
1テーブル毎に1ファイルとなっています。構造体の定義と、ドメインモデルとdtoの相互変換のメソッドが定義されています。

#### types

ユーザ定義の型をBunで取り扱うためのコードを格納します。ここで定義しておくことでSQLを叩く際にBunがラップを行いユーザ定義の型を取り扱いやすくなります。

### router

Echoを使ったルーティングやルーティングを行うルーターオブジェクトのカスタマイズを行います。
現在はバリデーションのみカスタマイズを行っています。

# DI

現在/internal/diでwireを使い依存関係の注入を行っています、開発中に依存関係の追加や変更があった場合は、wire.goに変更を加え、wireコマンドを使うことで更新します。

# データベース

Docker上のPostgreSQL v17.6を使用しています。テーブル定義する場合は単数形で命名します。
マイグレーションにはgolang-migrateと呼ばれるCLIを使用しています。
https://github.com/golang-migrate/migrate
テーブル定義等に変更を加える場合は既存のSQLに変更を加えるのではなく新たにマイグレーションを積み重ねるようにします。

# セキュリティ

このアプリケーションでは認証が必要になります。現時点では前ToyBoxと同様にDiscord認証のみを組み込むことを予定しています。Email認証やその他の認証、SSOなどは組み込みません。

# 運用方針

VPS上でDockerを使い動かすことを想定しています。1日に1度朝5時にDBに関してはバックアップを取得します。

# テスト方針

//TODO

# 更新履歴
2025/10/02 simesaba80